<!DOCTYPE html> 
<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta charset="utf-8" />
<title>Catalog of Life - Range Map Interface</title>
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" 
      rel="stylesheet" type="text/css" /> 
<link href='http://fonts.googleapis.com/css?family=Josefin+Sans'
      rel='stylesheet' type='text/css'>
<style>
#mol {
    font-family: 'Josefin Sans', arial, serif;
    font-size: 26px;
    font-style: normal;
    font-weight: 400;
    text-shadow: none;
    text-decoration: none;
    text-transform: none;
    letter-spacing: -0.037em;
    word-spacing: -0.108em;
    line-height: 1.17;
}
</style>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
</head> 
<body style="font: 75% Lucida Grande, Trebuchet MS"> 
<div id='mol'>Map of Life</div>
<p></p>
<div id="map_canvas" style="height:100%"></div>
<script> 
var app = app || {};

/**
 * MapType for range map tiles.
 */
app.rangMapType = new google.maps.ImageMapType({
    getTileUrl: function(coord, zoom) {
        var normalizedCoord = app.getNormalizedCoord(coord, zoom);
        if (!normalizedCoord) {
            return null;
        }
        var bound = Math.pow(2, zoom);
        
        return "/layers/{{key_name}}.png?" +
               "z=" + zoom + 
               "&x=" + normalizedCoord.x + 
               "&y=" + (normalizedCoord.y);
               //"&y=" + (bound - normalizedCoord.y - 1);
    },
    tileSize: new google.maps.Size(256, 256),
    isPng: true,
});

/**
 * Normalizes the coords that tiles repeat across the x axis (horizontally) like 
 * the standard Google map tiles.
 *
 */
app.getNormalizedCoord =  function(coord, zoom) {
    var y = coord.y    
    var x = coord.x;
    
    // tile range in one direction range is dependent on zoom level
    // 0 = 1 tile, 1 = 2 tiles, 2 = 4 tiles, 3 = 8 tiles, etc
    var tileRange = 1 << zoom;
    
    // don't repeat across y-axis (vertically)
    if (y < 0 || y >= tileRange) {
        return null;
    }
    
    // repeat across x-axis
    if (x < 0 || x >= tileRange) {
        x = (x % tileRange + tileRange) % tileRange;
    }
    
    return {
        x: x,
        y: y
    };
}

$ = (function () {
    var $ = function(id) {
        return document.getElementById(id);
    }
    var latlng = new google.maps.LatLng(0,0);        
    app.mapOptions = {
        zoom: 2,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.TERRAIN
    };
    app.map = new google.maps.Map(document.getElementById("map_canvas"), app.mapOptions);
    app.map.overlayMapTypes.insertAt(0, app.rangMapType);
    return $;
}());
</script>
</body>
</html>